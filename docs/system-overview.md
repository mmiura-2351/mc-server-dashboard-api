# Minecraft Server Dashboard API - システム概要

## 概要

Minecraft Server Dashboard APIは、複数のMinecraftサーバーを管理するためのWebベースのダッシュボードAPIです。ユーザー認証、ロールベースアクセス制御、リアルタイム監視機能を備えた包括的なサーバー管理システムを提供します。

## 🎯 システム目標

本システムは46の使用ケース（UC1-46）を完全にカバーし、以下の主要機能を提供します：

1. **マルチサーバー管理** - 複数のMinecraftサーバーの同時管理
2. **プレイヤー管理** - OP/ホワイトリストグループの動的管理
3. **リアルタイム監視** - サーバー状態とログのリアルタイム更新
4. **自動バックアップ** - スケジュール型バックアップと復元
5. **テンプレートシステム** - 再利用可能なサーバー設定
6. **ファイル管理** - 包括的なファイル操作
7. **セキュア認証** - JWT認証とロールベースアクセス制御

## 🏗️ アーキテクチャ

### 技術スタック
- **フレームワーク**: FastAPI (Python)
- **データベース**: SQLite (SQLAlchemy ORM)
- **認証**: JWT トークンベース認証
- **リアルタイム通信**: WebSocket
- **ファイル管理**: ローカルファイルシステム
- **プロセス管理**: Pythonサブプロセス

### コア構造
```
app/
├── main.py                    # FastAPIアプリケーションエントリポイント
├── core/                      # コア設定とデータベース
│   ├── config.py             # Pydantic設定管理
│   └── database.py           # SQLAlchemy設定
├── auth/                      # 認証システム
│   ├── auth.py              # JWT認証ロジック
│   ├── dependencies.py      # 認証依存関係
│   └── router.py            # 認証エンドポイント
├── users/                     # ユーザー管理
├── servers/                   # サーバー管理
├── groups/                    # グループ管理
├── backups/                   # バックアップシステム
├── templates/                 # テンプレートシステム
├── files/                     # ファイル管理
├── websockets/                # WebSocket通信
└── services/                  # ビジネスロジック層
```

### アーキテクチャパターン

#### レイヤード・アーキテクチャ
1. **プレゼンテーション層** - FastAPIルーター
2. **ビジネスロジック層** - Serviceクラス
3. **データアクセス層** - SQLAlchemyモデル
4. **インフラストラクチャ層** - ファイルシステム、プロセス管理

#### 依存性注入
- データベースセッション: `Depends(get_db)`
- 認証: `Depends(get_current_user)`
- サービス層: ビジネスロジック分離

## 🔐 セキュリティアーキテクチャ

### 認証・認可
- **JWT認証**: セキュアなトークンベース認証
- **ロールベースアクセス制御**: admin/operator/user の3段階権限
- **リソースアクセス制御**: 所有者ベースのアクセス制限

### データ保護
- **パスワードハッシュ**: bcryptによる安全なパスワード保存
- **ファイルパス検証**: ディレクトリトラバーサル攻撃対策
- **入力検証**: Pydanticモデルによる厳密な検証
- **監査ログ**: 全操作の追跡記録

## 📊 データモデル

### エンティティ関係図
```
Users (1) ←→ (N) Servers
Users (1) ←→ (N) Groups  
Users (1) ←→ (N) Templates
Servers (1) ←→ (N) Backups
Servers (N) ←→ (N) Groups (via ServerGroups)
Templates (1) ←→ (N) Servers
```

### 主要エンティティ
1. **Users** - ユーザー情報（認証、ロール、承認状態）
2. **Servers** - サーバー情報（設定、状態、ファイルパス）
3. **Groups** - グループ情報（OP/ホワイトリスト、プレイヤーリスト）
4. **Templates** - テンプレート情報（設定、デフォルトグループ）
5. **Backups** - バックアップ情報（メタデータ、ファイルパス）
6. **AuditLog** - 監査ログ（ユーザーアクション追跡）

## 🚀 機能詳細

### 1. サーバー管理（UC1-11）
- **マルチサーバー対応**: 複数のMinecraftサーバーを同時管理
- **サーバータイプサポート**: Vanilla、Forge、Paper対応
- **バージョン管理**: Minecraft 1.8～1.21.5対応
- **プロセス制御**: 開始、停止、再起動、コマンド実行
- **設定管理**: server.propertiesの動的更新

### 2. グループ管理（UC12-19）
- **OPグループ**: オペレーター権限の管理
- **ホワイトリストグループ**: アクセス許可プレイヤーの管理
- **マルチサーバー連携**: 複数サーバーへのグループ適用
- **動的更新**: グループ変更の即座サーバー反映

### 3. リアルタイム監視（UC20）
- **サーバー状態監視**: プロセス状態のリアルタイム追跡
- **ログストリーミング**: WebSocketによるコンソール出力ストリーム
- **通知システム**: システム全体の通知配信

### 4. バックアップシステム（UC21-28）
- **自動バックアップ**: スケジュール型バックアップ
- **手動バックアップ**: オンデマンドバックアップ作成
- **復元機能**: バックアップからのサーバー復元
- **テンプレート作成**: バックアップからのテンプレート生成

### 5. テンプレートシステム（UC7, UC37）
- **サーバーテンプレート**: 再利用可能なサーバー設定
- **カスタムテンプレート**: 独自設定テンプレートの作成
- **公開/非公開**: テンプレートの共有設定
- **クローン機能**: 既存テンプレートの複製

### 6. ファイル管理（UC29-37）
- **RESTfulAPI**: 直感的なファイル操作インターフェース
- **CRUD操作**: 読み取り、書き込み、削除操作
- **ディレクトリ管理**: フォルダ作成と管理
- **ファイル検索**: 名前・内容による検索
- **転送機能**: アップロード/ダウンロード

### 7. ユーザー管理（UC38-46）
- **ユーザー認証**: 登録、ログイン、プロフィール管理
- **承認システム**: 管理者による新規ユーザー承認
- **ロール管理**: user/operator/admin の権限管理
- **アカウント管理**: アクティベーション、非アクティブ化

## 🌐 API設計

### RESTful設計原則
- **リソース指向**: 明確なリソース識別
- **HTTPメソッド**: 適切なHTTPメソッド使用
- **ステータスコード**: 標準HTTPステータスコード
- **統一URL構造**: `/api/v1/` プレフィックス

### レスポンス形式
```json
{
  "id": 1,
  "name": "resource_name",
  "status": "active",
  "created_at": "2024-01-01T00:00:00Z"
}
```

### エラーハンドリング
```json
{
  "detail": "Descriptive error message"
}
```

## 📈 パフォーマンス最適化

### データベース最適化
- **インデックス**: 頻繁なクエリのインデックス最適化
- **ページネーション**: 大量データの効率的処理
- **クエリ最適化**: N+1問題の回避

### 非同期処理
- **ファイル操作**: 非同期I/O処理
- **プロセス管理**: 非同期プロセス監視
- **WebSocket**: 効率的なリアルタイム通信

## 🔧 開発・運用

### 開発環境
```bash
# アプリケーション起動
uv run fastapi dev

# テスト実行
uv run pytest

# コード品質チェック
uv run ruff check app/
uv run black app/

# カバレッジ測定
uv run coverage run -m pytest && uv run coverage report
```

### 設定管理
```env
SECRET_KEY=your-secret-key
DATABASE_URL=sqlite:///./app.db
```

### 品質保証
- **包括的テスト**: 主要機能の完全テストカバレッジ
- **コード品質**: Ruff linting + Black formatting
- **型安全性**: Pydanticモデルによる型チェック
- **セキュリティ**: 脆弱性対策の実装

## 🎯 使用ケース対応表

| カテゴリ | 使用ケース | 実装状況 | 主要エンドポイント |
|---------|-----------|---------|-------------------|
| サーバー管理 | UC1-7 | ✅ 完了 | `/api/v1/servers/*` |
| サーバー操作 | UC8-11 | ✅ 完了 | `/api/v1/servers/{id}/start` |
| プレイヤー管理 | UC12-19 | ✅ 完了 | `/api/v1/groups/*` |
| 監視 | UC20 | ✅ 完了 | WebSocket `/api/v1/ws/*` |
| バックアップ | UC21-28 | ✅ 完了 | `/api/v1/backups/*` |
| ファイル管理 | UC29-37 | ✅ 完了 | `/api/v1/files/*` |
| アカウント管理 | UC38-42 | ✅ 完了 | `/api/v1/auth/*` |
| 管理機能 | UC43-46 | ✅ 完了 | `/api/v1/users/*` |

この実装は、要求された46の使用ケースを完全にカバーし、堅牢なMinecraftサーバー管理システムを提供します。