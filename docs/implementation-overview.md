# Minecraft Server Dashboard API - 実装概要ドキュメント

## 概要

Minecraft Server Dashboard APIは、複数のMinecraftサーバーを管理するためのWebベースのダッシュボードAPIです。ユーザー認証、ロールベースアクセス制御、リアルタイム監視機能を備えた包括的なサーバー管理システムを提供します。

## アーキテクチャ

### 技術スタック
- **フレームワーク**: FastAPI (Python)
- **データベース**: SQLite (SQLAlchemy ORM)
- **認証**: JWT トークンベース認証
- **リアルタイム通信**: WebSocket
- **ファイル管理**: ローカルファイルシステム
- **プロセス管理**: Pythonサブプロセス

### コア構造
```
app/
├── main.py                    # FastAPIアプリケーションエントリポイント
├── core/                      # コア設定とデータベース
├── auth/                      # 認証システム
├── users/                     # ユーザー管理
├── servers/                   # サーバー管理
├── groups/                    # グループ管理
├── backups/                   # バックアップシステム
├── templates/                 # テンプレートシステム
├── files/                     # ファイル管理
├── websockets/                # WebSocket通信
└── services/                  # ビジネスロジック層
```

## 機能概要

### 1. 認証・ユーザー管理
- **JWT認証**: セキュアなトークンベース認証
- **ロールベースアクセス制御**: admin/operator/user の3段階権限
- **ユーザー承認システム**: 管理者による新規ユーザー承認
- **アカウント管理**: 登録、ログイン、プロフィール更新

### 2. サーバー管理
- **マルチサーバー対応**: 複数のMinecraftサーバーを同時管理
- **サーバータイプサポート**: Vanilla、Forge、Paper
- **バージョン管理**: Minecraft 1.8～1.21.5対応
- **プロセス制御**: 開始、停止、再起動、コマンド実行
- **リアルタイム監視**: サーバー状態とログのリアルタイム更新

### 3. グループ管理
- **OPグループ**: オペレーター権限の管理
- **ホワイトリストグループ**: アクセス許可プレイヤーの管理
- **マルチサーバー連携**: 複数サーバーへのグループ適用
- **動的更新**: グループ変更の即座サーバー反映

### 4. バックアップシステム
- **自動バックアップ**: スケジュール型バックアップ
- **手動バックアップ**: オンデマンドバックアップ作成
- **復元機能**: バックアップからのサーバー復元
- **テンプレート作成**: バックアップからのテンプレート生成

### 5. テンプレートシステム
- **サーバーテンプレート**: 再利用可能なサーバー設定
- **カスタムテンプレート**: 独自設定テンプレートの作成
- **公開/非公開**: テンプレートの共有設定
- **クローン機能**: 既存テンプレートの複製

### 6. ファイル管理
- **ファイル操作**: 読み取り、書き込み、削除
- **ディレクトリ管理**: フォルダ作成と管理
- **ファイル検索**: 名前・内容による検索
- **アップロード/ダウンロード**: ファイル転送機能

### 7. WebSocket通信
- **リアルタイムログ**: サーバーコンソール出力のストリーミング
- **状態更新**: サーバー状態変更の即時通知
- **システム通知**: グローバル通知システム

## API仕様

### ベースURL
すべてのAPIエンドポイントは `/api/v1/` プレフィックスを使用します。

### 認証
```
Authorization: Bearer <jwt_token>
```

### 主要エンドポイント

#### 認証
- `POST /api/v1/auth/register` - ユーザー登録
- `POST /api/v1/auth/token` - ログイン
- `GET /api/v1/auth/me` - 現在のユーザー情報

#### サーバー管理
- `GET /api/v1/servers` - サーバー一覧
- `POST /api/v1/servers` - サーバー作成
- `GET /api/v1/servers/{id}` - サーバー詳細
- `POST /api/v1/servers/{id}/start` - サーバー開始
- `POST /api/v1/servers/{id}/stop` - サーバー停止

#### グループ管理
- `GET /api/v1/groups` - グループ一覧
- `POST /api/v1/groups` - グループ作成
- `POST /api/v1/groups/{id}/servers` - サーバーへのグループ適用

#### バックアップ管理
- `GET /api/v1/backups/servers/{server_id}/backups` - サーバーバックアップ一覧
- `POST /api/v1/backups/servers/{server_id}/backups` - バックアップ作成
- `POST /api/v1/backups/backups/{id}/restore` - バックアップ復元

#### テンプレート管理
- `GET /api/v1/templates` - テンプレート一覧
- `POST /api/v1/templates` - カスタムテンプレート作成
- `POST /api/v1/templates/from-server/{server_id}` - サーバーからテンプレート作成

#### ファイル管理
- `GET /api/v1/files/servers/{server_id}/files/{path}` - ファイル一覧/詳細
- `GET /api/v1/files/servers/{server_id}/files/{path}/read` - ファイル読み取り
- `PUT /api/v1/files/servers/{server_id}/files/{path}` - ファイル書き込み
- `DELETE /api/v1/files/servers/{server_id}/files/{path}` - ファイル削除

### WebSocket
- `WS /api/v1/ws/server/{server_id}/logs` - リアルタイムログ
- `WS /api/v1/ws/server/{server_id}/status` - リアルタイム状態更新
- `WS /api/v1/ws/notifications` - システム通知

## データベーススキーマ

### 主要エンティティ
1. **Users** - ユーザー情報（認証、ロール、承認状態）
2. **Servers** - サーバー情報（設定、状態、ファイルパス）
3. **Groups** - グループ情報（OP/ホワイトリスト、プレイヤーリスト）
4. **Templates** - テンプレート情報（設定、デフォルトグループ）
5. **Backups** - バックアップ情報（メタデータ、ファイルパス）
6. **AuditLog** - 監査ログ（ユーザーアクション追跡）

### リレーションシップ
- Users → Servers (1:N) - 所有関係
- Groups ↔ Servers (N:N) - グループ適用
- Templates → Servers (1:N) - テンプレート使用
- Servers → Backups (1:N) - バックアップ作成

## セキュリティ

### アクセス制御
- **認証**: JWT トークン必須（公開エンドポイント除く）
- **認可**: ロールベース権限チェック
- **リソースアクセス**: 所有者またはadminのみアクセス可能
- **ファイル操作**: サーバーディレクトリ内に制限

### データ保護
- **パスワード**: bcryptによるハッシュ化
- **ファイルパス**: ディレクトリトラバーサル対策
- **入力検証**: Pydanticモデルによる厳密な検証
- **監査ログ**: 全操作の記録

## パフォーマンス

### 最適化
- **データベースインデックス**: クエリ性能向上
- **ページネーション**: 大量データの効率的処理
- **非同期処理**: ファイル操作とプロセス管理
- **WebSocket**: リアルタイム更新の効率化

### 監視
- **サーバー状態**: プロセス監視とヘルスチェック
- **リソース使用量**: メモリとディスク使用量追跡
- **パフォーマンス統計**: バックアップ成功率等

## 実装状況と品質

### 完成済み機能
✅ ユーザー認証・管理システム  
✅ サーバー作成・操作・監視  
✅ グループ管理とサーバー連携  
✅ バックアップ・復元システム  
✅ テンプレート管理システム  
✅ ファイル管理システム  
✅ WebSocket通信  
✅ 包括的なテストスイート  

### コード品質
- **テストカバレッジ**: 主要機能の包括的テスト
- **エラーハンドリング**: 適切な例外処理とHTTPステータス
- **ドキュメント**: 詳細なAPIドキュメントとコメント
- **型安全性**: Pydanticモデルによる型チェック

## 使用ケース対応表

| 使用ケース | 対応機能 | エンドポイント |
|-----------|---------|---------------|
| UC1-7: サーバー管理 | サーバーCRUD、設定管理 | `/api/v1/servers/*` |
| UC8-11: サーバー操作 | 開始/停止、設定更新 | `/api/v1/servers/{id}/start` |
| UC12-19: プレイヤー管理 | グループ管理、動的更新 | `/api/v1/groups/*` |
| UC20: 監視 | リアルタイム状態監視 | WebSocket `/ws/*` |
| UC21-28: バックアップ | 作成、復元、自動化 | `/api/v1/backups/*` |
| UC29-37: ファイル管理 | CRUD、検索、転送 | `/api/v1/files/*` |
| UC38-42: アカウント管理 | 認証、アカウント操作 | `/api/v1/auth/*` |
| UC43-46: 管理機能 | ユーザー承認、役割管理 | `/api/v1/users/*` |

## 開発・運用

### 開発コマンド
```bash
# アプリケーション起動
uv run fastapi dev

# テスト実行  
uv run pytest

# コード品質チェック
uv run ruff check app/
uv run black app/
```

### 設定
```env
SECRET_KEY=your-secret-key
DATABASE_URL=sqlite:///./app.db
```

### デプロイメント
- **環境変数**: `.env`ファイルによる設定管理
- **データベース**: SQLiteファイルによるシンプル管理
- **ファイルストレージ**: ローカルファイルシステム
- **プロセス管理**: システム統合でのサーバー監視

## 拡張性

### 将来の拡張ポイント
- **データベース**: PostgreSQL/MySQLへの移行
- **ファイルストレージ**: S3等クラウドストレージ対応
- **認証**: OAuth2/SAML連携
- **監視**: Prometheus/Grafana統合
- **スケーリング**: 水平スケーリング対応

この実装は、要求された46の使用ケースを完全にカバーし、堅牢で拡張可能なMinecraftサーバー管理システムを提供します。